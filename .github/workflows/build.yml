name: Build ASI

on: [push]

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Prepare JS parts
      shell: cmd
      run: |
        @echo off
        mkdir ASI_Loader\js_parts
        :: Разбиваем файл на части по 16KB
        powershell -Command "& { Get-Content custom.js -ReadCount 0 | Out-File -Encoding OEM ASI_Loader\js_parts\part_00 }"
        powershell -Command "& { $i=1; Get-Content custom.js -ReadCount 0 | Select-Object -Skip 16000 | Out-File -Encoding OEM ASI_Loader\js_parts\part_01 }"
        :: Добавьте дополнительные строки для большего количества частей

        :: Генерируем файл с данными
        echo const char* js_parts[] = { > ASI_Loader\js_data.h
        for %%f in (ASI_Loader\js_parts\part_*) do (
            echo R"=====( >> "%%f.tmp"
            type "%%f" >> "%%f.tmp"
            echo )=====", >> "%%f.tmp"
            type "%%f.tmp" >> ASI_Loader\js_data.h
        )
        echo }; >> ASI_Loader\js_data.h
        echo const int js_parts_count = %%~z >> ASI_Loader\js_data.h

    - name: Compile
      shell: cmd
      run: |
        cl /EHsc /std:c++17 /LD ASI_Loader\ASI_Loader.cpp /Fe:ASI_Loader.asi /link shlwapi.lib
        if %errorlevel% neq 0 exit /b %errorlevel%

    - uses: actions/upload-artifact@v4
      with:
        name: ASI_Loader
        path: ASI_Loader.asi
