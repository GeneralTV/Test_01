name: Build ASI

on: [push]

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1
      with:
        vs-version: '17.0'

    - name: Prepare environment
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        where cl
        where link

    - name: Prepare JS parts
      shell: powershell
      run: |
        if (-not (Test-Path "custom.js")) {
            Write-Error "File custom.js not found!"
            exit 1
        }

        New-Item -ItemType Directory -Path "ASI_Loader" -Force
        New-Item -ItemType Directory -Path "ASI_Loader/js_parts" -Force

        $content = [System.IO.File]::ReadAllText("custom.js", [System.Text.Encoding]::UTF8)
        $chunkSize = 15000
        $parts = @()

        for ($i=0; $i -lt $content.Length; $i+=$chunkSize) {
            $length = [Math]::Min($chunkSize, $content.Length - $i)
            $chunk = $content.Substring($i, $length)
            $partPath = "ASI_Loader/js_parts/part_$($i.ToString('00000')).h"
            Set-Content -Path $partPath -Value "R\"=====($chunk)=====\"" -NoNewline
            $parts += $partPath
        }

        $headerContent = @"
const char* js_parts[] = {
$($parts | ForEach-Object { Get-Content $_ -Raw } | Join-String -Separator ",")
};
const int js_parts_count = $($parts.Count);
"@
        Set-Content -Path "ASI_Loader/js_data.h" -Value $headerContent

    - name: Compile ASI
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cl /nologo /EHsc /std:c++17 /LD /Fe:ASI_Loader.asi ASI_Loader\ASI_Loader.cpp shlwapi.lib
        if not exist ASI_Loader.asi exit 1

    - uses: actions/upload-artifact@v4
      with:
        name: ASI_Loader
        path: ASI_Loader.asi
